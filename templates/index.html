{% extends "base.html" %}

{% block title %}Data Table with Date Range Picker{% endblock %}

{% block content %}
    <h2 class="mb-3">Data Table with Date Range Filter</h2>

    <!-- Date Range Picker -->
    <div class="mb-3">
        <label for="daterange">Select Date Range:</label>
        <input type="text" id="daterange" class="form-control" />
    </div>

    <!-- Data Table -->
    <table id="dataTable" class="table table-striped table-bordered dt-responsive nowrap">
        <thead>
            <tr>
                <th>Date</th>
                <th>Name</th>
                <th>Amount ($)</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <!-- ✅ jQuery (MUST BE FIRST) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- ✅ Moment.js (Fixes "moment is not defined" Error) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>

    <!-- ✅ Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- ✅ DataTables -->
    <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css" rel="stylesheet">
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>

    <!-- ✅ Bootstrap Date Range Picker -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-daterangepicker/3.1/daterangepicker.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-daterangepicker/3.1/daterangepicker.min.js"></script>

    <script>
        $(document).ready(function() {
            console.log("Page Loaded!");

            // ✅ Fix: Moment.js must be loaded before Date Range Picker
            console.log("Moment.js Version:", moment.version);

            // Initialize Date Range Picker
            $('#daterange').daterangepicker({
                opens: 'left',
                startDate: moment().subtract(30, 'days'),
                endDate: moment(),
                locale: { format: 'YYYY-MM-DD' }
            }, function(start, end) {
                console.log("Date range selected:", start.format('YYYY-MM-DD'), end.format('YYYY-MM-DD'));
                table.ajax.reload();
            });

            // Initialize DataTable
            let table = $('#dataTable').DataTable({
                responsive: true,
                processing: true,
                serverSide: false,
                ajax: {
                    url: "/filter",
                    type: "POST",
                    contentType: "application/json",
                    data: function() {
                        return JSON.stringify({
                            start_date: $('#daterange').data('daterangepicker').startDate.format('YYYY-MM-DD'),
                            end_date: $('#daterange').data('daterangepicker').endDate.format('YYYY-MM-DD')
                        });
                    },
                    dataSrc: ""
                },
                columns: [
                    { data: "Date" },
                    { data: "Name" },
                    { data: "Amount" }
                ]
            });

            // Reload table when date range is changed
            $('#daterange').on('apply.daterangepicker', function() {
                console.log("Reloading table...");
                table.ajax.reload();
            });
        });
    </script>
{% endblock %}
